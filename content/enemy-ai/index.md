+++
title = "敵AI"
date = 2021-06-10
+++

ほとんどの敵のAIはいわゆる[バイトコード](https://ja.wikipedia.org/wiki/%E3%83%90%E3%82%A4%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89)で実装されている。  
つまり、直接 6502 で書くのではなく、「ある方向へ移動する」「弾を撃つ」などの命令を備えたバイトコードで記述し、それを 6502 で書かれた仮想マシン上で動かしている。  
この方式の最大の利点は「処理の中断」が可能なことだろう。例えば「30フレーム横へ動き、60フレーム下へ動き、...」などといった処理を 6502 で直接書くと、多くの場合複雑なステートマシンを実装することになり面倒である。

バイトコードでなく専用ルーチンで動いている敵はルイド(ID: 0x11), リューク(ID: 0x14), ソープラー(ID: 0x21), スターブレイン(ID: 0x22, 0x23)のみ。  
ここではバイトコードに関する解説のみ行う。

以下、バイトコードで実装された敵のうちジェリコ、ラザロを「ボス」、それ以外を「ザコ」と総称する。

## ツール

バイトコードの[アセンブラ/逆アセンブラ](https://github.com/taotao54321/starsoldier-bytecode)を作成した。以下、命令のニーモニックはこのアセンブラを基準とする。

[playground](https://taotao54321.github.io/starsoldier-bytecode-playground/) で実際のバイトコードの動作が見られる。

## 仮想マシン

敵1体ごと(ボスの場合、1パーツごと)に仮想マシンが割り当てられる。

ここでは仮想マシンの実装をやや抽象化して記述する。また、レジスタ名などは筆者が独自に命名したものである。

### アドレス空間

仮想マシンのアドレス空間は 8bit で、ROM 上のバイトコードがマップされる。このアドレス空間は読み取り専用である。

### レジスタ

仮想マシンは以下のレジスタを持つ:

| 名前              | 型     | 用途                                           |
| --                | --     | --                                             |
| `pc`              | `u8`   | プログラムカウンタ                             |
| `loop_counter`    | `u8`   | ループカウンタ                                 |
| `loop_start_addr` | `u8`   | ループ開始アドレス                             |
| `jump_on_damage`  | `u8`   | ザコの場合:被弾時のジャンプ先<br>ボスの場合:HP |
| `sleep_timer`     | `u8`   | 仮想マシンのスリープタイマー                   |
| `homing_timer`    | `u8`   | 自機追尾タイマー                               |
| `inv_x`           | `bool` | x 方向の移動を反転                             |
| `inv_y`           | `bool` | y 方向の移動を反転                             |

ループ関連レジスタが1組しかないことからわかるように、1重ループのみサポートしている。

### 命令セット

仮想マシンは以下の命令を持つ:

| オペコード            | ニーモニック         | 機能                                  | 実行の中断 |
| --                    | --                   | --                                    | --         |
| `0x00..=0x3F`         | `move`               | 敵を指定方向へ移動                    | Yes        |
| `0x40`                | `jump`               | ジャンプ                              | No         |
| `0x41..=0x4F`         | `set_sleep_timer`    | `sleep_timer` を設定                  | Yes        |
| `0x50`, `0x52..=0x5F` | `loop_begin`         | 指定回数のループを開始                | No         |
| `0x51`                | `loop_end`           | ループ末尾                            | No         |
| `0x60..=0x6F`         | `shoot_direction`    | 方向指定弾を撃つ (未使用)             | No         |
| `0x70..=0x7F`         | `set_sprite`         | 敵メタスプライトIDを設定              | No         |
| `0x80..=0x8F`         | `set_homing_timer`   | `homing_timer` を設定                 | No         |
| `0x90..=0x93`         | `set_inversion`      | `inv_x`, `inv_y` を設定               | No         |
| `0xA0`                | `set_position`       | 敵座標を設定                          | No         |
| `0xA1`                | `set_jump_on_damage` | `jump_on_damage` を設定               | Yes        |
| `0xA2`                | `increment_sprite`   | 敵メタスプライトIDをインクリメント    | No         |
| `0xA3`                | `decrement_sprite`   | 敵メタスプライトIDをデクリメント      | No         |
| `0xA4`                | `set_part`           | 敵パーツ番号を設定                    | No         |
| `0xA5`                | `randomize_x`        | 敵座標x をランダムに変更              | No         |
| `0xA6`                | `randomize_y`        | 敵座標y をランダムに変更              | No         |
| `0xB0`                | `bcc_x`              | `(敵座標x) <  (自機座標x)` ならば分岐 | No         |
| `0xB1`                | `bcs_x`              | `(敵座標x) >= (自機座標x)` ならば分岐 | No         |
| `0xB2`                | `bcc_y`              | `(敵座標y) <  (自機座標y)` ならば分岐 | No         |
| `0xB3`                | `bcs_y`              | `(敵座標y) >= (自機座標y)` ならば分岐 | No         |
| `0xC0..=0xCF`         | `shoot_aim`          | 自機狙い弾を撃つ                      | No         |
| `0xF0`                | `restore_music`      | BGM をデフォルトに戻す                | No         |
| `0xF1..=0xFF`         | `play_sound`         | 指定したサウンドを鳴らす              | No         |
